{% extends "base.html" %}

{% block title %}Izveštaji - Time Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title mb-0">
                        <i class="bi bi-graph-up text-primary me-2"></i>
                        Izveštaji i analitika
                    </h2>
                    <p class="text-muted mb-0">Pregled vremena rada i statistika</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Types -->
    {% if current_user.is_super_admin() or current_user.is_company_admin() %}
    <!-- Admin Reports -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-person-lines-fill text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">Izveštaj po korisnicima</h5>
                    <p class="card-text text-muted">Pregled vremena rada po korisnicima i projektima</p>
                    <a href="{{ url_for('reports.user_summary') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-right me-2"></i>
                        Pregled
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-folder-check text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">Izveštaj po projektima</h5>
                    <p class="card-text text-muted">Analiza vremena rada na pojedinačnim projektima</p>
                    <a href="{{ url_for('reports.project_summary') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-right me-2"></i>
                        Pregled
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-building-check text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">Izveštaj po kompanijama</h5>
                    <p class="card-text text-muted">Zbirni pregled za klijente i kompanije</p>
                    <a href="{{ url_for('reports.company_summary') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-right me-2"></i>
                        Pregled
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <i class="bi bi-calendar-day text-primary" style="font-size: 3rem;"></i>
                    </div>
                    <h5 class="card-title">Dnevni izveštaj</h5>
                    <p class="card-text text-muted">Detaljni pregled aktivnosti po danima</p>
                    <a href="{{ url_for('reports.daily_report') }}" class="btn btn-primary">
                        <i class="bi bi-arrow-right me-2"></i>
                        Pregled
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <!-- User Report - Direct Integration -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title">
                        <i class="bi bi-person-circle me-2"></i>
                        Moj lični izveštaj
                    </h4>
                    <p class="text-muted mb-0">Pregled vaših radnih sati i zarade</p>
                </div>
                <div class="card-body">
                    <!-- Filters -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <label for="start-date" class="form-label">Od datuma</label>
                            <input type="text" id="start-date" class="form-control" placeholder="DD.MM.YYYY" value="{{ start_date or '' }}">
                        </div>
                        <div class="col-md-3">
                            <label for="end-date" class="form-label">Do datuma</label>
                            <input type="text" id="end-date" class="form-control" placeholder="DD.MM.YYYY" value="{{ end_date or '' }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" id="filter-btn" class="btn btn-primary d-block">
                                <i class="bi bi-funnel"></i> Filtriraj
                            </button>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <a href="{{ url_for('reports.export_my_report_excel', start_date=start_date, end_date=end_date) }}" class="btn btn-success d-block">
                                <i class="bi bi-file-earmark-excel"></i> Preuzmi Excel
                            </a>
                        </div>
                    </div>

                    <!-- Summary Cards -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card text-center" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                <div class="card-body">
                                    <h5 class="card-title text-white-50">Ukupno sati</h5>
                                    <h3 class="mb-0 text-white">{{ "%.1f"|format(total_hours) }}h</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- All Entries Table -->
                    {% if all_entries %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-table me-2"></i>
                                Svi unosi vremena
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Datum</th>
                                            <th>Kompanija</th>
                                            <th>Projekat</th>
                                            <th>Sati</th>
                                            <th>Opis</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for entry in all_entries %}
                                        <tr>
                                            <td><strong>{{ entry.date.strftime('%d.%m.%Y') }}</strong></td>
                                            <td>
                                                <span class="badge bg-info">{{ entry.company_name }}</span>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ entry.project_name }}</span>
                                            </td>
                                            <td>{{ "%.1f"|format(entry.hours) }}h</td>
                                            <td>
                                                {% if entry.description %}
                                                    <small class="text-muted">{{ entry.description }}</small>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-dark">
                                            <td colspan="3"><strong>UKUPNO</strong></td>
                                            <td><strong>{{ "%.1f"|format(total_hours) }}h</strong></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Report Content -->
                    {% if report_data %}
                        {% for company_name, company_data in report_data.items() %}
                        <div class="card mb-4">
                            <div class="card-header" style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-building me-2"></i>
                                    {{ company_name }}
                                </h5>
                                <div class="mt-2">
                                    <span class="badge bg-primary">Ukupno: {{ "%.1f"|format(company_data.total_hours) }}h</span>
                                </div>
                            </div>
                            <div class="card-body">
                                {% for project_name, project_data in company_data.projects.items() %}
                                <div class="mb-4">
                                    <h6 class="text-primary mb-3">
                                        <i class="bi bi-folder me-2"></i>
                                        {{ project_name }}
                                    </h6>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-sm table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Datum</th>
                                                    <th>Sati</th>
                                                    <th>Opis</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for date_str, daily_data in project_data.daily_entries.items() %}
                                                <tr>
                                                    <td><strong>{{ date_str }}</strong></td>
                                                    <td>{{ "%.1f"|format(daily_data.hours) }}h</td>
                                                    <td>
                                                        {% if daily_data.description %}
                                                            <small class="text-muted">{{ daily_data.description }}</small>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                            <tfoot>
                                                <tr class="table-info">
                                                    <td><strong>UKUPNO ZA PROJEKAT</strong></td>
                                                    <td><strong>{{ "%.1f"|format(project_data.total_hours) }}h</strong></td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- Final Summary -->
                        <div class="card mt-4" style="background: linear-gradient(135deg, #1f2937 0%, #111827 100%); color: white;">
                            <div class="card-body text-center">
                                <h4 class="mb-3">
                                    <i class="bi bi-calculator me-2"></i>
                                    UKUPAN ZBIR ZA PERIOD
                                </h4>
                                <div class="row">
                                    <div class="col-md-12">
                                        <h5 class="text-white-50">Ukupno sati</h5>
                                        <h2 class="text-white">{{ "%.1f"|format(total_hours) }}h</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-file-earmark-text text-muted" style="font-size: 4rem;"></i>
                            <h4 class="text-muted mt-3">Nema podataka za prikaz</h4>
                            <p class="text-muted">Nema unosa vremena za odabrani period.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section for Regular Users -->
    {% if report_data %}
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart me-2"></i>
                        Raspodela po kompanijama
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="companyChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-bar-chart me-2"></i>
                        Sati po projektima
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="projectChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    {% endif %}

    {% if current_user.is_super_admin() or current_user.is_company_admin() %}
    <!-- Quick Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        Brzi filteri
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Period</label>
                            <select class="form-select" id="quickPeriod">
                                <option value="">Izaberi period</option>
                                <option value="today">Danas</option>
                                <option value="week">Ova nedelja</option>
                                <option value="month">Ovaj mesec</option>
                                <option value="quarter">Ovaj kvartal</option>
                                <option value="year">Ova godina</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Projekat</label>
                            <select class="form-select" id="quickProject">
                                <option value="">Svi projekti</option>
                                <!-- Will be populated via AJAX -->
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Korisnik</label>
                            <select class="form-select" id="quickUser">
                                <option value="">Svi korisnici</option>
                                <!-- Will be populated via AJAX -->
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="applyQuickFilter()">
                                    <i class="bi bi-search me-2"></i>
                                    Primeni filter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if current_user.is_super_admin() or current_user.is_company_admin() %}
    <!-- Recent Activity Chart -->
    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        Aktivnost u poslednjih 7 dana
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-pie-chart me-2"></i>
                        Raspodela po projektima
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="projectChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-speedometer2 me-2"></i>
                        Brze statistike
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row" id="quickStats">
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-primary mb-0" id="totalHours">0h</h3>
                                <small class="text-muted">Ukupno sati</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-success mb-0" id="activeProjects">0</h3>
                                <small class="text-muted">Aktivni projekti</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-info mb-0" id="activeUsers">0</h3>
                                <small class="text-muted">Aktivni korisnici</small>
                            </div>
                        </div>
                        <div class="col-md-3 text-center mb-3">
                            <div class="border rounded p-3">
                                <h3 class="text-warning mb-0" id="avgHours">0h</h3>
                                <small class="text-muted">Prosečno po danu</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if current_user.is_super_admin() or current_user.is_company_admin() %}
    loadQuickStats();
    loadActivityChart();
    loadProjectChart();
    loadFilterOptions();
    {% else %}
    // For regular users, load charts for their personal report
    {% if report_data %}
    loadUserCharts();
    {% endif %}
    {% endif %}
});

{% if not (current_user.is_super_admin() or current_user.is_company_admin()) and report_data %}
// Filter functionality for regular users
document.getElementById('filter-btn').addEventListener('click', function() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;
    
    let url = new URL(window.location);
    if (startDate) {
        url.searchParams.set('start_date', startDate);
    } else {
        url.searchParams.delete('start_date');
    }
    if (endDate) {
        url.searchParams.set('end_date', endDate);
    } else {
        url.searchParams.delete('end_date');
    }
    
    window.location.href = url.toString();
});

// Load charts for regular users
function loadUserCharts() {
    // Chart data
    const chartData = {
        companies: {
            labels: [{% for company_name, company_data in report_data.items() %}'{{ company_name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            hours: [{% for company_name, company_data in report_data.items() %}{{ company_data.total_hours }}{% if not loop.last %}, {% endif %}{% endfor %}]
        },
        projects: {
            labels: [],
            hours: []
        }
    };

    // Prepare project data
    {% for company_name, company_data in report_data.items() %}
        {% for project_name, project_data in company_data.projects.items() %}
            chartData.projects.labels.push('{{ project_name }}');
            chartData.projects.hours.push({{ project_data.total_hours }});
        {% endfor %}
    {% endfor %}

    // Company Chart (Pie)
    const companyCtx = document.getElementById('companyChart').getContext('2d');
    new Chart(companyCtx, {
        type: 'pie',
        data: {
            labels: chartData.companies.labels,
            datasets: [{
                data: chartData.companies.hours,
                backgroundColor: [
                    '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                    '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value}h (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });

    // Project Chart (Bar)
    const projectCtx = document.getElementById('projectChart').getContext('2d');
    new Chart(projectCtx, {
        type: 'bar',
        data: {
            labels: chartData.projects.labels,
            datasets: [{
                label: 'Sati',
                data: chartData.projects.hours,
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Sati'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}
{% endif %}

// Load quick statistics
function loadQuickStats() {
    fetch('{{ url_for("reports.api_report_data") }}?type=stats')
    .then(response => response.json())
    .then(data => {
        document.getElementById('totalHours').textContent = data.total_hours + 'h';
        document.getElementById('activeProjects').textContent = data.active_projects;
        document.getElementById('activeUsers').textContent = data.active_users;
        document.getElementById('avgHours').textContent = data.avg_hours + 'h';
    })
    .catch(error => {
        console.error('Error loading quick stats:', error);
    });
}

// Load activity chart
function loadActivityChart() {
    const ctx = document.getElementById('activityChart').getContext('2d');
    
    fetch('{{ url_for("reports.api_report_data") }}?type=daily&days=7')
    .then(response => response.json())
    .then(data => {
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(item => item.date),
                datasets: [{
                    label: 'Sati rada',
                    data: data.map(item => item.total_hours),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Sati'
                        }
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading activity chart:', error);
    });
}

// Load project chart
function loadProjectChart() {
    const ctx = document.getElementById('projectChart').getContext('2d');
    
    fetch('{{ url_for("reports.api_report_data") }}?type=user_project')
    .then(response => response.json())
    .then(data => {
        // Group by project
        const projectData = {};
        data.forEach(item => {
            if (!projectData[item.project_name]) {
                projectData[item.project_name] = 0;
            }
            projectData[item.project_name] += item.total_hours;
        });
        
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: Object.keys(projectData),
                datasets: [{
                    data: Object.values(projectData),
                    backgroundColor: [
                        '#667eea',
                        '#764ba2',
                        '#f093fb',
                        '#f5576c',
                        '#4facfe',
                        '#00f2fe'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    })
    .catch(error => {
        console.error('Error loading project chart:', error);
    });
}

// Load filter options
function loadFilterOptions() {
    // Load projects
    fetch('{{ url_for("main.api_time_entries") }}')
    .then(response => response.json())
    .then(data => {
        const projects = [...new Set(data.map(item => item.project_name))];
        const projectSelect = document.getElementById('quickProject');
        
        projects.forEach(project => {
            const option = document.createElement('option');
            option.value = project;
            option.textContent = project;
            projectSelect.appendChild(option);
        });
    })
    .catch(error => {
        console.error('Error loading filter options:', error);
    });
}

// Apply quick filter
function applyQuickFilter() {
    const period = document.getElementById('quickPeriod').value;
    const project = document.getElementById('quickProject').value;
    const user = document.getElementById('quickUser').value;
    
    // Calculate date range based on period
    let startDate = '';
    let endDate = '';
    
    if (period) {
        const today = new Date();
        const start = new Date();
        
        switch(period) {
            case 'today':
                startDate = endDate = today.toISOString().split('T')[0];
                break;
            case 'week':
                start.setDate(today.getDate() - 7);
                startDate = start.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
                break;
            case 'month':
                start.setMonth(today.getMonth() - 1);
                startDate = start.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
                break;
            case 'quarter':
                start.setMonth(today.getMonth() - 3);
                startDate = start.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
                break;
            case 'year':
                start.setFullYear(today.getFullYear() - 1);
                startDate = start.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
                break;
        }
    }
    
    // Redirect to user summary with filters
    let url = '{{ url_for("reports.user_summary") }}?';
    if (startDate) url += `start_date=${startDate}&`;
    if (endDate) url += `end_date=${endDate}&`;
    if (project) url += `project=${encodeURIComponent(project)}&`;
    if (user) url += `user=${encodeURIComponent(user)}&`;
    
    window.location.href = url;
}
</script>
{% endblock %} 